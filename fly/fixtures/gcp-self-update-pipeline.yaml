
---
resources:
- name: control-tower-release
  type: github-release
  icon: github
  check_every: 30m
  source:
    user: engineerbetter
    repository: control-tower
    pre_release: true

jobs:
- name: self-update
  serial_groups: [cup]
  serial: true
  plan:
  - get: control-tower-release
    trigger: true
  - task: update
    params:
      AWS_REGION: "europe-west1"
      DEPLOYMENT: "my-deployment"
      GCPCreds: ((google_self_update_credentials))
      IAAS: "GCP"
      NAMESPACE: "prod"
      ALLOW_IPS: "10.0.0.0"
      SELF_UPDATE: true
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: engineerbetter/pcf-ops
      inputs:
      - name: control-tower-release
      run:
        path: bash
        args:
        - -c
        - |
          cd control-tower-release
          echo "${GCPCreds}" > googlecreds.json
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/googlecreds.json
          set -eux
          chmod +x control-tower-linux-amd64
          ./control-tower-linux-amd64 deploy $DEPLOYMENT
